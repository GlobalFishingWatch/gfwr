---
title: "Using `get_vessel_info()`: the basics of vessel identity in `gfwr`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using `get_vessel_info()`: the basics of vessel identity in `gfwr`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#",
  eval = T
)
```

```{r setup, eval = F}
library(gfwr)
```

```{r load, eval = T, include = FALSE}
devtools::load_all() 
```

This vignette explains the use of `get_vessel_info()` as a key function to understand vessel identity and to use all the other Global Fishing Watch API endpoints.

The package main vignette provides examples of the general use of the function, but here we discuss the structure of the `get_vessel_info()` response and how to get __Vessel ID__ for use in the functions `get_event()` and `get_event_stats()`. 


## Automatic Identification System (AIS) 

The Automatic Identification System (AIS) is an automatic tracking system originally developed to help preventing collisions between vessels at sea. 
Vessels broadcast AIS to  alert other vessels of their presence, but terrestrial and satellite receivers can also receive these messages and monitor vessel movements. 

AIS messages include identity information about the vessel, such as ship name, call sign, and International Maritime Organization (IMO) number, as well as an identifier known as the Maritime Mobile Service Identity (MMSI). 

- __MMSI__ are nine-digit numbers broadcasted in AIS messages. MMSI are supposed to be unique for each vessel but can be duplicated for many reasons--including the fact that the data entry in AIS messages is manual.

- __Shipname__ and __callsign__ can be also transmitted in AIS messages but they are optional, not every AIS-broadcasting vessel transmits them, or their transmission can be inconsistent.

- __IMO numbers__ are permanent unique identifiers that follow a vessel from construction to scrapping. Assigned by the International Maritime Organization, these can be also used to identify vessels and can be transmitted along with MMSI, but they are optional, frequently missing in AIS messages.

Function `get_vessel_info()` can search for vessels using any of these identifiers.

Let's start with a simple search by MMSI. To get information of a vessel using its MMSI, IMO number, callsign or name, the search can be done directly using the number or the string. For example, to look for a vessel with `MMSI = 224224000`, the number is enough:

```{r example_vessel_info_1}
mmsi_search <- get_vessel_info(query = 224224000,
                search_type = "search",
                key = gfw_auth())
```

By default the search will assume it's an MMSI, and if the MMSI is not found, IMO will be considered, followed by the other identity markers. 


The response from the API is a list with seven elements: 

```{r str}
names(mmsi_search)
```

The content of the original AIS message transmitted by the vessel appears in `$selfReportedInfo`:

```{r self, max.width=10}
mmsi_search$selfReportedInfo
```

As you can see this vessel returns two lines of code. One corresponds to our original search, ssvid (MMSI) equals 224224000.

The second line has a different ssvid, but the same name and IMO number. The two lines correspond to the same vessel, and as you can see it has been reflagged from BES to ESP, an operation that implies the change of ssvid because the first three digits of ssvid correspond to the flag country. 

As you can see here, that vessel had one flag and ssvid between 2015 and 2019, then it was reflagged and operates with a BES flag since 2019 and until 2023.

```{r , message=FALSE}
library(dplyr)
mmsi_search$selfReportedInfo %>% 
  select(id, ssvid, flag, contains("Date"))
```

The field `id` in this example corresponds to Global Fishing Watch Vessel ID.


## Vessel ID `VesselId`

To solve the complexity of having several vessel identifiers that can be duplicated or missing for each vessel and that can change in time, Global Fishing Watch developed `vesselId`, a unified vessel identity variable that combines vessel information and is specific to a specific time interval.

The same vessel hull can thus have shifting identity markers in time, and detecting which VesselID is the vessel of interest in each case is key to analyses. 
 
> **Note**:
> The spelling `vesselId` follows our API convention but you may encounter several ways to spell it across our documentation, including "vessel ID" and "vessel id", and in some tables it appears only as `id` 

A `vesselId` is composed by a combination of the MMSI and the IMO number when available, or by the MMSI, callsign and shipname transmitted in AIS messages. 

Each `vesselId` will be associated to a single MMSI at a specific period of time, and refers to a single vessel, but a single MMSI can have many associated vessel IDs simultaneously. 

A vessel can have both different SSVIDs and different vesselIDs in time, but Global Fishing Watch keeps track of the several vesselIDs a single vessel can have in time. 

This is why simple calls to `get_vessel_info()` can return tables that have many rows and different identity markers in time.

In our example, both lines returned correspond to the same vessel. 


## Registry data 

Global Fishing Watch also compiles vessel information from over 40 public vessel registries and matches this information with the AIS-transmitted identity fields. 

Registry matching allows to identity if and when vessels are registered for activities in the regions they operate, it can provide ownership information and understand better the identity of a given vessel. 

`get_vessel_info()` returns some dataframes related to registry information




The vesselID can be extracted by using either

- `$selfReportedInfo$id` or `$combinedSourcesInfo$vesselID`

- `$selfReportedInfo` is the data that comes from the AIS message

- `$combinedSourcesInfo` comes from the combination of sources



To do more specific searches (`imo = '8300949'`), combine different fields (`imo = '8300949' AND ssvid = '214182732'`) and do fuzzy matching (`"shipname LIKE '%GABU REEFE%' OR imo = '8300949'"`), use parameter `where` instead of `query`:

```{r example_vessel_info_2}
get_vessel_info(where = "shipname LIKE '%GABU REEFE%' OR imo = '8300949'",
                search_type = "search",
                key = gfw_auth())
```

> **Note**:
> In `gfwr` tables, the MMSI field that comes from AIS is referred to as SSVID (source-specific vessel ID, because other sources can have different names for that fiels). Searches using SQL expressions have to be written as "ssvid = '214182732'"


* The `id` search allows the user to specify a vector of `vessel id`

> **Note**:
> `vessel id` is an internal ID generated by GFW to connect data accross APIs
and involves a combination of vessel and tracking data information. It can be
retrieved using `get_vessel_info()` as shown above.


To search using `vessel id`:

```{r example_vessel_info_3}
get_vessel_info(ids = "8c7304226-6c71-edbe-0b63-c246734b3c01",
                search_type = "id",
                key = gfw_auth())
```

To specify more than one `vessel id`, you can submit a vector of identifiers:

```{r example_vessel_info_4}
get_vessel_info(ids = c("8c7304226-6c71-edbe-0b63-c246734b3c01",
                        "6583c51e3-3626-5638-866a-f47c3bc7ef7c",
                        "71e7da672-2451-17da-b239-857831602eca"),
                search_type = 'id',
                key = gfw_auth())
```



On our map, the vessel search is located at https://globalfishingwatch.org/map/vessel-search.


# Read more:

- https://globalfishingwatch.org/datasets-and-code-vessel-identity/
- https://globalfishingwatch.org/data/spoofing-one-identity-shared-by-multiple-vessels/ 
- Park et al. (2023). Tracking elusive and shifting identities of the global fishing fleet

